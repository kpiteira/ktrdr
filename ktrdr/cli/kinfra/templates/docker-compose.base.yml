# KTRDR Sandbox Slot Template
# Generated by kinfra sandbox provision
#
# This template uses ${VARIABLE:-default} syntax for port substitution.
# The .env.sandbox file in each slot provides slot-specific values.
#
# Usage:
#   cd ~/.ktrdr/sandboxes/slot-N
#   docker compose up -d
#
# Port variables (from .env.sandbox):
#   KTRDR_API_PORT, KTRDR_DB_PORT, KTRDR_GRAFANA_PORT,
#   KTRDR_JAEGER_UI_PORT, KTRDR_PROMETHEUS_PORT

services:
  # PostgreSQL + TimescaleDB - Time-series optimized database
  db:
    image: timescale/timescaledb:latest-pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${KTRDR_DB_NAME:-ktrdr}
      POSTGRES_USER: ${KTRDR_DB_USER:-ktrdr}
      POSTGRES_PASSWORD: ${KTRDR_DB_PASSWORD:-localdev}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${KTRDR_DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KTRDR_DB_USER:-ktrdr}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ktrdr-network

  # FastAPI Backend - Central orchestrator
  backend:
    image: ${KTRDR_BACKEND_IMAGE:-ktrdr-backend:dev}
    restart: unless-stopped
    ports:
      - "${KTRDR_API_PORT:-8000}:8000"
    volumes:
      # Shared data directories
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies
      # Cache directories
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      # Database
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
      - DATABASE_URL=postgresql://${KTRDR_DB_USER:-ktrdr}:${KTRDR_DB_PASSWORD:-localdev}@db:5432/${KTRDR_DB_NAME:-ktrdr}
      # Observability
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      # IB Host Service (runs natively on Mac)
      - KTRDR_IB_HOST_ENABLED=${KTRDR_IB_HOST_ENABLED:-true}
      - KTRDR_IB_HOST_HOST=host.docker.internal
      - KTRDR_IB_HOST_PORT=5001
      # JWT for API auth
      - KTRDR_AUTH_JWT_SECRET=${KTRDR_AUTH_JWT_SECRET:-local-dev-secret-minimum-32-characters-long}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network

  # Jaeger - Distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:1.53
    restart: unless-stopped
    ports:
      - "${KTRDR_JAEGER_UI_PORT:-16686}:16686"
      - "4317:4317"    # OTLP gRPC (internal only)
      - "4318:4318"    # OTLP HTTP (internal only)
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    ports:
      - "${KTRDR_PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - prometheus_data:/prometheus
    command:
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Grafana - Dashboards
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "${KTRDR_GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - jaeger
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Backtest Worker - Runs backtesting operations
  # Worker count controlled by starting/stopping this service
  backtest-worker:
    image: ${KTRDR_BACKEND_IMAGE:-ktrdr-backend:dev}
    restart: unless-stopped
    stop_grace_period: 30s
    volumes:
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models:ro
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=backtesting
      - KTRDR_WORKER_PORT=5003
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port 5003

  # Training Worker - Runs training operations
  # Worker count controlled by starting/stopping this service
  training-worker:
    image: ${KTRDR_BACKEND_IMAGE:-ktrdr-backend:dev}
    restart: unless-stopped
    stop_grace_period: 30s
    volumes:
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=training
      - KTRDR_WORKER_PORT=5005
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port 5005

networks:
  ktrdr-network:
    driver: bridge

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  pip-cache:
  uv-cache:
