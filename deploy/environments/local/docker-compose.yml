# KTRDR Local Development Environment
# Single command startup: docker compose -f docker-compose.dev.yml up
#
# Services: db, backend, prometheus, grafana, jaeger, 4 workers
# All services on single network with hot reload enabled
#
# IMAGE MODE: To test with CI-built images from GHCR instead of building locally:
# 1. Authenticate: echo $GITHUB_PAT | docker login ghcr.io -u <username> --password-stdin
# 2. Comment out 'build:' sections below and uncomment 'image:' lines
# 3. Run: docker compose -f docker-compose.dev.yml up
# To use a specific version: IMAGE_TAG=sha-abc1234 docker compose -f docker-compose.dev.yml up

services:
  # PostgreSQL + TimescaleDB - Time-series optimized database
  db:
    image: timescale/timescaledb:latest-pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-ktrdr}
      POSTGRES_USER: ${DB_USER:-ktrdr}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-localdev}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ktrdr}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ktrdr-network

  # FastAPI Backend - Central orchestrator
  backend:
    # Build mode (default for development)
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    # Image mode (uncomment to test with CI-built images)
    # image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # Mount source code for hot-reloading
      - ./ktrdr:/app/ktrdr
      - ./research_agents:/app/research_agents
      - ./tests:/app/tests
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ./strategies:/app/strategies  # Writable for agent to save strategies
      - ./models:/app/models
      - ./output:/app/output
      - ./training_analytics:/app/training_analytics
      - ./memory:/app/memory  # Agent memory (experiments, hypotheses)
      # Database migrations
      - ./alembic:/app/alembic:ro
      - ./alembic.ini:/app/alembic.ini:ro
      # Cache directories
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      # Agent model configuration (Task 8.3)
      # Valid: claude-opus-4-5-20251101, claude-sonnet-4-5-20250929, claude-haiku-4-5-20251001
      - KTRDR_AGENT_MODEL=${KTRDR_AGENT_MODEL:-claude-opus-4-5-20251101}
      - PYTHONPATH=/app
      # Agent E2E testing (comment out for real workers)
      - USE_STUB_WORKERS=${USE_STUB_WORKERS:-false}
      - STUB_WORKER_FAST=${STUB_WORKER_FAST:-false}
      # Database
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
      # Full DATABASE_URL for agent sessions (research_agents module)
      - DATABASE_URL=postgresql://${KTRDR_DB_USER:-ktrdr}:${KTRDR_DB_PASSWORD:-localdev}@db:5432/${KTRDR_DB_NAME:-ktrdr}
      # Backend API URL (used by workers and agents to connect to backend)
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      # Observability
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      # Checkpointing
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      # IB Host Service (runs natively on Mac)
      - KTRDR_IB_HOST_ENABLED=${KTRDR_IB_HOST_ENABLED:-true}
      - KTRDR_IB_HOST_HOST=host.docker.internal
      - KTRDR_IB_HOST_PORT=5001
      # JWT for API auth
      - KTRDR_AUTH_JWT_SECRET=${KTRDR_AUTH_JWT_SECRET:-local-dev-secret-minimum-32-characters-long}
      # Agent configuration (Phase 1)
      # NOTE: KTRDR_AGENT_ENABLED and KTRDR_AGENT_TRIGGER_INTERVAL are placeholders
      # for future agent auto-trigger functionality (not yet consumed by backend)
      - KTRDR_AGENT_ENABLED=${KTRDR_AGENT_ENABLED:-false}
      - KTRDR_AGENT_TRIGGER_INTERVAL=${KTRDR_AGENT_TRIGGER_INTERVAL:-300}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Agent E2E testing date ranges (1d timeframe for fast testing)
      # For production: remove these or set to full ranges (2005-2020 train, 2020-today backtest)
      - KTRDR_AGENT_TRAINING_START_DATE=${KTRDR_AGENT_TRAINING_START_DATE:-2015-01-01}
      - KTRDR_AGENT_TRAINING_END_DATE=${KTRDR_AGENT_TRAINING_END_DATE:-2019-12-31}
      - KTRDR_AGENT_BACKTEST_START_DATE=${KTRDR_AGENT_BACKTEST_START_DATE:-2020-01-01}
      - KTRDR_AGENT_BACKTEST_END_DATE=${KTRDR_AGENT_BACKTEST_END_DATE:-2021-12-31}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network

  # Jaeger - Distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:1.53
    restart: unless-stopped
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Grafana - Dashboards
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
    volumes:
      # Paths relative to project root (where docker-compose symlink is)
      - ./deploy/shared/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./deploy/shared/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./deploy/shared/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - jaeger
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Backtest Worker 1
  backtest-worker-1:
    # Build mode (default)
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    # Image mode (uncomment to test with CI-built images)
    # image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    restart: unless-stopped
    # M6: Graceful shutdown - gives worker 30s to save checkpoint before SIGKILL
    stop_grace_period: 30s
    ports:
      - "5003:5003"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./data:/app/data  # RW for checkpoint artifacts
      - ./models:/app/models:ro
      - ./strategies:/app/strategies:ro
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=backtesting
      - KTRDR_WORKER_PORT=5003
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://backtest-worker-1:5003
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      # Database access for checkpointing
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port 5003 --reload

  # Backtest Worker 2
  backtest-worker-2:
    # Build mode (default)
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    # Image mode (uncomment to test with CI-built images)
    # image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    restart: unless-stopped
    # M6: Graceful shutdown - gives worker 30s to save checkpoint before SIGKILL
    stop_grace_period: 30s
    ports:
      - "5004:5004"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./data:/app/data  # RW for checkpoint artifacts
      - ./models:/app/models:ro
      - ./strategies:/app/strategies:ro
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=backtesting
      - KTRDR_WORKER_PORT=5004
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://backtest-worker-2:5004
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port 5004 --reload

  # Training Worker 1
  training-worker-1:
    # Build mode (default)
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    # Image mode (uncomment to test with CI-built images)
    # image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    restart: unless-stopped
    # M6: Graceful shutdown - gives worker 30s to save checkpoint before SIGKILL
    stop_grace_period: 30s
    ports:
      - "5005:5005"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./data:/app/data  # RW for checkpoint artifacts
      - ./models:/app/models
      - ./strategies:/app/strategies:ro
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=training
      - KTRDR_WORKER_PORT=5005
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://training-worker-1:5005
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port 5005 --reload

  # Training Worker 2
  training-worker-2:
    # Build mode (default)
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    # Image mode (uncomment to test with CI-built images)
    # image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    restart: unless-stopped
    # M6: Graceful shutdown - gives worker 30s to save checkpoint before SIGKILL
    stop_grace_period: 30s
    ports:
      - "5006:5006"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./data:/app/data  # RW for checkpoint artifacts
      - ./models:/app/models
      - ./strategies:/app/strategies:ro
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=training
      - KTRDR_WORKER_PORT=5006
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://training-worker-2:5006
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port 5006 --reload

  # MCP Server (Local) - For Claude Code/Desktop targeting local backend
  # NOTE: MCP code is mounted at /mcp (not /app/mcp) to avoid shadowing the pip 'mcp' package
  mcp-local:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    volumes:
      - ../../../mcp:/mcp:ro           # Mount outside /app to avoid shadowing pip mcp package
      - ../../../ktrdr:/app/ktrdr:ro
      - ../../../research_agents:/app/research_agents:ro  # Agent research package
      - ../../../config:/app/config:ro  # Config files for KTRDR
      - ./logs:/app/logs
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app:/mcp    # Include both /app (for ktrdr) and /mcp (for src)
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
    working_dir: /mcp
    stdin_open: true  # Required for stdio MCP transport
    networks:
      - ktrdr-network
    depends_on:
      backend:
        condition: service_healthy
    # No command - container stays running, Claude exec's into it
    command: ["sleep", "infinity"]

  # MCP Server (Pre-prod) - For Claude Code/Desktop targeting pre-prod backend
  # NOTE: MCP code is mounted at /mcp (not /app/mcp) to avoid shadowing the pip 'mcp' package
  mcp-preprod:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    volumes:
      - ../../../mcp:/mcp:ro           # Mount outside /app to avoid shadowing pip mcp package
      - ../../../ktrdr:/app/ktrdr:ro
      - ../../../research_agents:/app/research_agents:ro  # Agent research package
      - ../../../config:/app/config:ro  # Config files for KTRDR
      - ./logs:/app/logs
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app:/mcp    # Include both /app (for ktrdr) and /mcp (for src)
      - KTRDR_API_CLIENT_BASE_URL=http://backend.ktrdr.home.mynerd.place:8000/api/v1
      - KTRDR_OTEL_OTLP_ENDPOINT=http://backend.ktrdr.home.mynerd.place:4317
    working_dir: /mcp
    stdin_open: true  # Required for stdio MCP transport
    networks:
      - ktrdr-network
    # No depends_on - pre-prod backend is external
    command: ["sleep", "infinity"]

networks:
  ktrdr-network:
    driver: bridge

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  pip-cache:
  uv-cache:
