# KTRDR Sandbox Environment
# Isolated container for Claude Code autonomous task execution
#
# Usage:
#   ./scripts/sandbox-init.sh      # First-time setup (clones repo)
#   docker compose up -d           # Start sandbox
#   ./scripts/sandbox-reset.sh     # Reset workspace to clean state
#   ./scripts/sandbox-shell.sh     # Interactive shell
#   ./scripts/sandbox-claude.sh    # Run Claude Code command
#
# Requires:
#   - GH_TOKEN environment variable (for GitHub CLI PR creation)
#   - ~/Documents/ktrdr-shared/data/ directory with market data
#   - Claude Code login (run `claude login` in sandbox first time)

services:
  sandbox:
    build:
      context: ../../../
      dockerfile: deploy/docker/sandbox/Dockerfile
    image: ktrdr-sandbox:latest
    container_name: ktrdr-sandbox
    restart: unless-stopped

    environment:
      - TERM=xterm-256color
      # GitHub token for PR creation (passed from host environment)
      - GH_TOKEN=${GH_TOKEN}
      # Prefix all containers created by sandbox with "sandbox-" to avoid
      # conflicts with host development containers
      - COMPOSE_PROJECT_NAME=sandbox

    volumes:
      # Docker socket for running ktrdr services from inside sandbox
      # SECURITY: This grants full Docker daemon access. Only run in trusted
      # development environments, never with untrusted code or in production.
      - /var/run/docker.sock:/var/run/docker.sock

      # Shared market data (read-only)
      - ${HOME}/Documents/ktrdr-shared/data:/shared/data:ro

      # Named volumes for persistent storage
      - sandbox-workspace:/workspace
      - sandbox-claude-credentials:/home/ubuntu/.claude
      - sandbox-models:/env/models
      - sandbox-strategies:/env/strategies
      - sandbox-logs:/env/logs

    # Enable host access for communicating with host services
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Join ktrdr network for service communication
    networks:
      - ktrdr-network

    # Keep container running for exec commands
    stdin_open: true
    tty: true

networks:
  ktrdr-network:
    # Use existing network if available, create if not
    name: ktrdr-network
    external: false

volumes:
  sandbox-workspace:
    name: ktrdr-sandbox-workspace
  sandbox-claude-credentials:
    name: ktrdr-sandbox-claude-credentials
  sandbox-models:
    name: ktrdr-sandbox-models
  sandbox-strategies:
    name: ktrdr-sandbox-strategies
  sandbox-logs:
    name: ktrdr-sandbox-logs
