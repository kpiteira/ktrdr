# KTRDR Sandbox Development Environment
# For running multiple isolated KTRDR stacks in parallel.
#
# Usage:
#   ktrdr sandbox up  # Recommended - handles secrets automatically
#
# Manual usage (not recommended):
#   docker compose -f docker-compose.sandbox.yml up -d
#
# =============================================================================
# SECRETS MANAGEMENT
# =============================================================================
# Secrets (DB_PASSWORD, JWT_SECRET, ANTHROPIC_API_KEY, GF_ADMIN_PASSWORD) are
# fetched from 1Password at startup by 'ktrdr sandbox up'.
#
# 1Password item: ktrdr-sandbox-dev
# Required fields: db_password, jwt_secret, anthropic_api_key, grafana_password
#
# The defaults below are INSECURE fallbacks for --no-secrets mode only.
# They allow the stack to start for CI/testing but should never be used
# for actual development work.
#
# =============================================================================
# PORT VARIABLES
# =============================================================================
# All ports are parameterized with defaults matching the main docker-compose.yml.
#   KTRDR_API_PORT, KTRDR_DB_PORT, KTRDR_GRAFANA_PORT,
#   KTRDR_JAEGER_UI_PORT, KTRDR_JAEGER_OTLP_GRPC_PORT, KTRDR_JAEGER_OTLP_HTTP_PORT,
#   KTRDR_PROMETHEUS_PORT, KTRDR_WORKER_PORT_1-4
#
# Shared Data Variables (defaults to local ./data, ./models, ./strategies):
#   KTRDR_DATA_DIR, KTRDR_MODELS_DIR, KTRDR_STRATEGIES_DIR
#
# See docs/designs/Sandbox/ARCHITECTURE.md for port allocation scheme.

services:
  # PostgreSQL + TimescaleDB - Time-series optimized database
  db:
    image: timescale/timescaledb:latest-pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-ktrdr}
      POSTGRES_USER: ${DB_USER:-ktrdr}
      # INSECURE default - use 1Password via 'ktrdr sandbox up'
      POSTGRES_PASSWORD: ${DB_PASSWORD:-localdev}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${KTRDR_DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ktrdr}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ktrdr-network

  # FastAPI Backend - Central orchestrator
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    ports:
      - "${KTRDR_API_PORT:-8000}:8000"
    volumes:
      # Instance-specific (hot reload)
      - ./ktrdr:/app/ktrdr
      - ./research_agents:/app/research_agents
      - ./tests:/app/tests
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ./output:/app/output
      - ./training_analytics:/app/training_analytics
      - ./memory:/app/memory
      # Database migrations
      - ./alembic:/app/alembic:ro
      - ./alembic.ini:/app/alembic.ini:ro
      # Shared data with fallback to local (backward compatible)
      # Set KTRDR_DATA_DIR, KTRDR_MODELS_DIR, KTRDR_STRATEGIES_DIR for shared data
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies
      # Cache directories
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - KTRDR_AGENT_MODEL=${KTRDR_AGENT_MODEL:-claude-opus-4-5-20251101}
      - PYTHONPATH=/app
      - USE_STUB_WORKERS=${USE_STUB_WORKERS:-false}
      - STUB_WORKER_FAST=${STUB_WORKER_FAST:-false}
      # Database
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
      - DATABASE_URL=postgresql://${KTRDR_DB_USER:-ktrdr}:${KTRDR_DB_PASSWORD:-localdev}@db:5432/${KTRDR_DB_NAME:-ktrdr}
      # Backend API URL (used by workers and agents to connect to backend)
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      # Observability
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      # Checkpointing
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      # IB Host Service (runs natively on Mac)
      - KTRDR_IB_HOST_ENABLED=${KTRDR_IB_HOST_ENABLED:-true}
      - KTRDR_IB_HOST_HOST=host.docker.internal
      - KTRDR_IB_HOST_PORT=5001
      # JWT for API auth (INSECURE default - use 1Password via 'ktrdr sandbox up')
      - KTRDR_AUTH_JWT_SECRET=${KTRDR_AUTH_JWT_SECRET:-local-dev-secret-minimum-32-characters-long}
      # Agent configuration
      - KTRDR_AGENT_ENABLED=${KTRDR_AGENT_ENABLED:-false}
      - KTRDR_AGENT_TRIGGER_INTERVAL=${KTRDR_AGENT_TRIGGER_INTERVAL:-300}
      # From 1Password - empty default disables agents
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - KTRDR_AGENT_TRAINING_START_DATE=${KTRDR_AGENT_TRAINING_START_DATE:-2015-01-01}
      - KTRDR_AGENT_TRAINING_END_DATE=${KTRDR_AGENT_TRAINING_END_DATE:-2019-12-31}
      - KTRDR_AGENT_BACKTEST_START_DATE=${KTRDR_AGENT_BACKTEST_START_DATE:-2020-01-01}
      - KTRDR_AGENT_BACKTEST_END_DATE=${KTRDR_AGENT_BACKTEST_END_DATE:-2021-12-31}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network

  # Jaeger - Distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:1.53
    restart: unless-stopped
    ports:
      - "${KTRDR_JAEGER_UI_PORT:-16686}:16686"
      - "${KTRDR_JAEGER_OTLP_GRPC_PORT:-4317}:4317"
      - "${KTRDR_JAEGER_OTLP_HTTP_PORT:-4318}:4318"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    ports:
      - "${KTRDR_PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Grafana - Dashboards
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "${KTRDR_GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      # INSECURE default - use 1Password via 'ktrdr sandbox up'
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
    volumes:
      - ./deploy/shared/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./deploy/shared/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./deploy/shared/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - jaeger
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Backtest Worker 1
  # Workers need matching internal/external ports for registration
  backtest-worker-1:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_1:-5003}:5003"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      # Shared data with fallback to local
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models:ro
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=backtesting
      - KTRDR_WORKER_PORT=5003
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://backtest-worker-1:5003
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port 5003 --reload

  # Backtest Worker 2
  backtest-worker-2:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_2:-5004}:5004"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models:ro
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=backtesting
      - KTRDR_WORKER_PORT=5004
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://backtest-worker-2:5004
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port 5004 --reload

  # Training Worker 1
  training-worker-1:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_3:-5005}:5005"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=training
      - KTRDR_WORKER_PORT=5005
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://training-worker-1:5005
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port 5005 --reload

  # Training Worker 2
  training-worker-2:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_4:-5006}:5006"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - WORKER_TYPE=training
      - KTRDR_WORKER_PORT=5006
      - KTRDR_WORKER_PUBLIC_BASE_URL=http://training-worker-2:5006
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
      - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
      - KTRDR_DB_HOST=db
      - KTRDR_DB_PORT=5432
      - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
      - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
      - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port 5006 --reload

  # MCP Server (Local) - For Claude Code/Desktop targeting local backend
  # NOTE: MCP code is mounted at /mcp (not /app/mcp) to avoid shadowing the pip 'mcp' package
  # This service starts with regular 'up' (no profile needed) for local-prod usage.
  mcp-local:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    volumes:
      - ./mcp:/mcp:ro              # Mount outside /app to avoid shadowing pip mcp package
      - ./ktrdr:/app/ktrdr:ro
      - ./research_agents:/app/research_agents:ro  # Agent research package
      - ./config:/app/config:ro    # Config files for KTRDR
      - ./logs:/app/logs
    environment:
      - KTRDR_API_ENVIRONMENT=development
      - KTRDR_LOG_LEVEL=INFO
      - PYTHONPATH=/app:/mcp       # Include both /app (for ktrdr) and /mcp (for src)
      - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
      - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
    working_dir: /mcp
    stdin_open: true               # Required for stdio MCP transport
    networks:
      - ktrdr-network
    depends_on:
      backend:
        condition: service_healthy
    # No command - container stays running, Claude exec's into it
    command: ["sleep", "infinity"]

  # =============================================================================
  # EXTRA WORKERS (local-prod profile only) - CURRENTLY DISABLED
  # =============================================================================
  # Uncomment these workers if you need more than 4 workers for local-prod.
  # These workers only start when using --profile local-prod.
  #
  # To enable: uncomment the worker definitions below and run:
  #   docker compose --profile local-prod up -d
  #
  # Port assignments (from sandbox_ports.py slot 0):
  #   backtest-worker-3:  5007 (KTRDR_WORKER_PORT_5)
  #   backtest-worker-4:  5008 (KTRDR_WORKER_PORT_6)
  #   training-worker-3:  5009 (KTRDR_WORKER_PORT_7)
  #   training-worker-4:  5010 (KTRDR_WORKER_PORT_8)

  # # Backtest Worker 3 (local-prod only)
  # backtest-worker-3:
  #   profiles: [local-prod]
  #   build:
  #     context: .
  #     dockerfile: docker/backend/Dockerfile.dev
  #     cache_from:
  #       - ktrdr-backend:dev
  #   image: ktrdr-backend:dev
  #   restart: unless-stopped
  #   stop_grace_period: 30s
  #   ports:
  #     - "${KTRDR_WORKER_PORT_5:-5007}:5007"
  #   volumes:
  #     - ./ktrdr:/app/ktrdr
  #     - ./logs:/app/logs
  #     - ./config:/app/config:ro
  #     - ${KTRDR_DATA_DIR:-./data}:/app/data
  #     - ${KTRDR_MODELS_DIR:-./models}:/app/models:ro
  #     - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
  #     - pip-cache:/root/.cache/pip
  #     - uv-cache:/root/.cache/uv
  #   environment:
  #     - KTRDR_API_ENVIRONMENT=development
  #     - KTRDR_LOG_LEVEL=INFO
  #     - PYTHONPATH=/app
  #     - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
  #     - WORKER_TYPE=backtesting
  #     - KTRDR_WORKER_PORT=5007
  #     - KTRDR_WORKER_PUBLIC_BASE_URL=http://backtest-worker-3:5007
  #     - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
  #     - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
  #     - KTRDR_DB_HOST=db
  #     - KTRDR_DB_PORT=5432
  #     - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
  #     - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
  #     - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:5007/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   networks:
  #     - ktrdr-network
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #     backend:
  #       condition: service_started
  #   command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port 5007 --reload

  # # Backtest Worker 4 (local-prod only)
  # backtest-worker-4:
  #   profiles: [local-prod]
  #   build:
  #     context: .
  #     dockerfile: docker/backend/Dockerfile.dev
  #     cache_from:
  #       - ktrdr-backend:dev
  #   image: ktrdr-backend:dev
  #   restart: unless-stopped
  #   stop_grace_period: 30s
  #   ports:
  #     - "${KTRDR_WORKER_PORT_6:-5008}:5008"
  #   volumes:
  #     - ./ktrdr:/app/ktrdr
  #     - ./logs:/app/logs
  #     - ./config:/app/config:ro
  #     - ${KTRDR_DATA_DIR:-./data}:/app/data
  #     - ${KTRDR_MODELS_DIR:-./models}:/app/models:ro
  #     - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
  #     - pip-cache:/root/.cache/pip
  #     - uv-cache:/root/.cache/uv
  #   environment:
  #     - KTRDR_API_ENVIRONMENT=development
  #     - KTRDR_LOG_LEVEL=INFO
  #     - PYTHONPATH=/app
  #     - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
  #     - WORKER_TYPE=backtesting
  #     - KTRDR_WORKER_PORT=5008
  #     - KTRDR_WORKER_PUBLIC_BASE_URL=http://backtest-worker-4:5008
  #     - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
  #     - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
  #     - KTRDR_DB_HOST=db
  #     - KTRDR_DB_PORT=5432
  #     - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
  #     - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
  #     - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:5008/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   networks:
  #     - ktrdr-network
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #     backend:
  #       condition: service_started
  #   command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port 5008 --reload

  # # Training Worker 3 (local-prod only)
  # training-worker-3:
  #   profiles: [local-prod]
  #   build:
  #     context: .
  #     dockerfile: docker/backend/Dockerfile.dev
  #     cache_from:
  #       - ktrdr-backend:dev
  #   image: ktrdr-backend:dev
  #   restart: unless-stopped
  #   stop_grace_period: 30s
  #   ports:
  #     - "${KTRDR_WORKER_PORT_7:-5009}:5009"
  #   volumes:
  #     - ./ktrdr:/app/ktrdr
  #     - ./logs:/app/logs
  #     - ./config:/app/config:ro
  #     - ${KTRDR_DATA_DIR:-./data}:/app/data
  #     - ${KTRDR_MODELS_DIR:-./models}:/app/models
  #     - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
  #     - pip-cache:/root/.cache/pip
  #     - uv-cache:/root/.cache/uv
  #   environment:
  #     - KTRDR_API_ENVIRONMENT=development
  #     - KTRDR_LOG_LEVEL=INFO
  #     - PYTHONPATH=/app
  #     - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
  #     - WORKER_TYPE=training
  #     - KTRDR_WORKER_PORT=5009
  #     - KTRDR_WORKER_PUBLIC_BASE_URL=http://training-worker-3:5009
  #     - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
  #     - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
  #     - KTRDR_DB_HOST=db
  #     - KTRDR_DB_PORT=5432
  #     - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
  #     - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
  #     - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:5009/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   networks:
  #     - ktrdr-network
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #     backend:
  #       condition: service_started
  #   command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port 5009 --reload

  # # Training Worker 4 (local-prod only)
  # training-worker-4:
  #   profiles: [local-prod]
  #   build:
  #     context: .
  #     dockerfile: docker/backend/Dockerfile.dev
  #     cache_from:
  #       - ktrdr-backend:dev
  #   image: ktrdr-backend:dev
  #   restart: unless-stopped
  #   stop_grace_period: 30s
  #   ports:
  #     - "${KTRDR_WORKER_PORT_8:-5010}:5010"
  #   volumes:
  #     - ./ktrdr:/app/ktrdr
  #     - ./logs:/app/logs
  #     - ./config:/app/config:ro
  #     - ${KTRDR_DATA_DIR:-./data}:/app/data
  #     - ${KTRDR_MODELS_DIR:-./models}:/app/models
  #     - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
  #     - pip-cache:/root/.cache/pip
  #     - uv-cache:/root/.cache/uv
  #   environment:
  #     - KTRDR_API_ENVIRONMENT=development
  #     - KTRDR_LOG_LEVEL=INFO
  #     - PYTHONPATH=/app
  #     - KTRDR_API_CLIENT_BASE_URL=http://backend:8000/api/v1
  #     - WORKER_TYPE=training
  #     - KTRDR_WORKER_PORT=5010
  #     - KTRDR_WORKER_PUBLIC_BASE_URL=http://training-worker-4:5010
  #     - KTRDR_OTEL_OTLP_ENDPOINT=http://jaeger:4317
  #     - KTRDR_CHECKPOINT_DIR=/app/data/checkpoints
  #     - KTRDR_DB_HOST=db
  #     - KTRDR_DB_PORT=5432
  #     - KTRDR_DB_NAME=${KTRDR_DB_NAME:-ktrdr}
  #     - KTRDR_DB_USER=${KTRDR_DB_USER:-ktrdr}
  #     - KTRDR_DB_PASSWORD=${KTRDR_DB_PASSWORD:-localdev}
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:5010/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   networks:
  #     - ktrdr-network
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #     backend:
  #       condition: service_started
  #   command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port 5010 --reload

networks:
  ktrdr-network:
    driver: bridge

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  pip-cache:
  uv-cache:
