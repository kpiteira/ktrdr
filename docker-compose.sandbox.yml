# KTRDR Sandbox Development Environment
# For running multiple isolated KTRDR stacks in parallel.
#
# Usage:
#   export COMPOSE_PROJECT_NAME=ktrdr-test-1
#   export KTRDR_API_PORT=8001
#   export KTRDR_DB_PORT=5433
#   # ... other port vars ...
#   docker compose -f docker-compose.sandbox.yml up -d
#
# All ports are parameterized with defaults matching the main docker-compose.yml.
# When no env vars are set, this file behaves identically to docker-compose.yml.
#
# Port Variables (all have defaults matching current docker-compose.yml):
#   KTRDR_API_PORT, KTRDR_DB_PORT, KTRDR_GRAFANA_PORT,
#   KTRDR_JAEGER_UI_PORT, KTRDR_JAEGER_OTLP_GRPC_PORT, KTRDR_JAEGER_OTLP_HTTP_PORT,
#   KTRDR_PROMETHEUS_PORT, KTRDR_WORKER_PORT_1-4
#
# Shared Data Variables (defaults to local ./data, ./models, ./strategies):
#   KTRDR_DATA_DIR, KTRDR_MODELS_DIR, KTRDR_STRATEGIES_DIR
#
# See docs/designs/Sandbox/ARCHITECTURE.md for port allocation scheme.

services:
  # PostgreSQL + TimescaleDB - Time-series optimized database
  db:
    image: timescale/timescaledb:latest-pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-ktrdr}
      POSTGRES_USER: ${DB_USER:-ktrdr}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-localdev}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${KTRDR_DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ktrdr}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ktrdr-network

  # FastAPI Backend - Central orchestrator
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    ports:
      - "${KTRDR_API_PORT:-8000}:8000"
    volumes:
      # Instance-specific (hot reload)
      - ./ktrdr:/app/ktrdr
      - ./research_agents:/app/research_agents
      - ./tests:/app/tests
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ./output:/app/output
      - ./training_analytics:/app/training_analytics
      - ./memory:/app/memory
      # Shared data with fallback to local (backward compatible)
      # Set KTRDR_DATA_DIR, KTRDR_MODELS_DIR, KTRDR_STRATEGIES_DIR for shared data
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies
      # Cache directories
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
      - AGENT_MODEL=${AGENT_MODEL:-claude-opus-4-5-20251101}
      - PYTHONPATH=/app
      - USE_STUB_WORKERS=${USE_STUB_WORKERS:-false}
      - STUB_WORKER_FAST=${STUB_WORKER_FAST:-false}
      # Database
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-ktrdr}
      - DB_USER=${DB_USER:-ktrdr}
      - DB_PASSWORD=${DB_PASSWORD:-localdev}
      - DATABASE_URL=postgresql://${DB_USER:-ktrdr}:${DB_PASSWORD:-localdev}@db:5432/${DB_NAME:-ktrdr}
      # Backend API URL
      - KTRDR_API_URL=http://backend:8000
      # Observability
      - OTLP_ENDPOINT=http://jaeger:4317
      # Checkpointing
      - CHECKPOINT_DIR=/app/data/checkpoints
      # IB Host Service (runs natively on Mac)
      - USE_IB_HOST_SERVICE=${USE_IB_HOST_SERVICE:-true}
      - IB_HOST_SERVICE_URL=http://host.docker.internal:5001
      # JWT for API auth
      - JWT_SECRET=${JWT_SECRET:-local-dev-secret-minimum-32-characters-long}
      # Agent configuration
      - AGENT_ENABLED=${AGENT_ENABLED:-false}
      - AGENT_TRIGGER_INTERVAL_SECONDS=${AGENT_TRIGGER_INTERVAL_SECONDS:-300}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - AGENT_TRAINING_START_DATE=${AGENT_TRAINING_START_DATE:-2015-01-01}
      - AGENT_TRAINING_END_DATE=${AGENT_TRAINING_END_DATE:-2019-12-31}
      - AGENT_BACKTEST_START_DATE=${AGENT_BACKTEST_START_DATE:-2020-01-01}
      - AGENT_BACKTEST_END_DATE=${AGENT_BACKTEST_END_DATE:-2021-12-31}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy
      jaeger:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network

  # Jaeger - Distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:1.53
    restart: unless-stopped
    ports:
      - "${KTRDR_JAEGER_UI_PORT:-16686}:16686"
      - "${KTRDR_JAEGER_OTLP_GRPC_PORT:-4317}:4317"
      - "${KTRDR_JAEGER_OTLP_HTTP_PORT:-4318}:4318"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    ports:
      - "${KTRDR_PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Grafana - Dashboards
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "${KTRDR_GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
    volumes:
      - ./deploy/shared/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./deploy/shared/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./deploy/shared/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - jaeger
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Backtest Worker 1
  # Workers need matching internal/external ports for registration
  backtest-worker-1:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_1:-5003}:${KTRDR_WORKER_PORT_1:-5003}"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      # Shared data with fallback to local
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models:ro
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_URL=http://backend:8000
      - WORKER_TYPE=backtesting
      - WORKER_PORT=${KTRDR_WORKER_PORT_1:-5003}
      - WORKER_PUBLIC_BASE_URL=http://backtest-worker-1:${KTRDR_WORKER_PORT_1:-5003}
      - OTLP_ENDPOINT=http://jaeger:4317
      - CHECKPOINT_DIR=/app/data/checkpoints
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-ktrdr}
      - DB_USER=${DB_USER:-ktrdr}
      - DB_PASSWORD=${DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${KTRDR_WORKER_PORT_1:-5003}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port ${KTRDR_WORKER_PORT_1:-5003} --reload

  # Backtest Worker 2
  backtest-worker-2:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_2:-5004}:${KTRDR_WORKER_PORT_2:-5004}"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models:ro
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_URL=http://backend:8000
      - WORKER_TYPE=backtesting
      - WORKER_PORT=${KTRDR_WORKER_PORT_2:-5004}
      - WORKER_PUBLIC_BASE_URL=http://backtest-worker-2:${KTRDR_WORKER_PORT_2:-5004}
      - OTLP_ENDPOINT=http://jaeger:4317
      - CHECKPOINT_DIR=/app/data/checkpoints
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-ktrdr}
      - DB_USER=${DB_USER:-ktrdr}
      - DB_PASSWORD=${DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${KTRDR_WORKER_PORT_2:-5004}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.backtesting.backtest_worker:app --host 0.0.0.0 --port ${KTRDR_WORKER_PORT_2:-5004} --reload

  # Training Worker 1
  training-worker-1:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_3:-5005}:${KTRDR_WORKER_PORT_3:-5005}"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_URL=http://backend:8000
      - WORKER_TYPE=training
      - WORKER_PORT=${KTRDR_WORKER_PORT_3:-5005}
      - WORKER_PUBLIC_BASE_URL=http://training-worker-1:${KTRDR_WORKER_PORT_3:-5005}
      - OTLP_ENDPOINT=http://jaeger:4317
      - CHECKPOINT_DIR=/app/data/checkpoints
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-ktrdr}
      - DB_USER=${DB_USER:-ktrdr}
      - DB_PASSWORD=${DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${KTRDR_WORKER_PORT_3:-5005}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port ${KTRDR_WORKER_PORT_3:-5005} --reload

  # Training Worker 2
  training-worker-2:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile.dev
      cache_from:
        - ktrdr-backend:dev
    image: ktrdr-backend:dev
    restart: unless-stopped
    stop_grace_period: 30s
    ports:
      - "${KTRDR_WORKER_PORT_4:-5006}:${KTRDR_WORKER_PORT_4:-5006}"
    volumes:
      - ./ktrdr:/app/ktrdr
      - ./logs:/app/logs
      - ./config:/app/config:ro
      - ${KTRDR_DATA_DIR:-./data}:/app/data
      - ${KTRDR_MODELS_DIR:-./models}:/app/models
      - ${KTRDR_STRATEGIES_DIR:-./strategies}:/app/strategies:ro
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
      - PYTHONPATH=/app
      - KTRDR_API_URL=http://backend:8000
      - WORKER_TYPE=training
      - WORKER_PORT=${KTRDR_WORKER_PORT_4:-5006}
      - WORKER_PUBLIC_BASE_URL=http://training-worker-2:${KTRDR_WORKER_PORT_4:-5006}
      - OTLP_ENDPOINT=http://jaeger:4317
      - CHECKPOINT_DIR=/app/data/checkpoints
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-ktrdr}
      - DB_USER=${DB_USER:-ktrdr}
      - DB_PASSWORD=${DB_PASSWORD:-localdev}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${KTRDR_WORKER_PORT_4:-5006}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      db:
        condition: service_healthy
      backend:
        condition: service_started
    command: /app/.venv/bin/uvicorn ktrdr.training.training_worker:app --host 0.0.0.0 --port ${KTRDR_WORKER_PORT_4:-5006} --reload

networks:
  ktrdr-network:
    driver: bridge

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  pip-cache:
  uv-cache:
