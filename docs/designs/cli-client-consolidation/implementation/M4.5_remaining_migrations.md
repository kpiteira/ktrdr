---
design: ../DESIGN.md
architecture: ../ARCHITECTURE.md
---

# Milestone 4.5: Remaining Migrations

**Branch:** `feature/cli-client-consolidation-m4.5`
**Builds on:** M2, M3, M4
**Goal:** All command files migrated to new unified client. No old client imports remain.

## Background

Task 5.0 (Pre-Deletion E2E Verification) discovered that several command files still use old client imports:

| File | Old Import | Commands Affected |
|------|------------|-------------------|
| `async_model_commands.py` | `operation_executor.py` | `models train` |
| `data_commands.py` | `api_client.py` | `data load` |
| `dummy_commands.py` | `api_client.py`, `operation_executor.py` | `dummy dummy` |
| `model_commands.py` | `api_client.py` | Unused (not wired to CLI) |

**Note:** `async_model_commands.py` is the ACTIVE file for `ktrdr models` commands, not `model_commands.py`. The M4 migration updated the wrong file.

## E2E Test Scenario

```bash
# After M4.5, these greps should return NOTHING:
grep -r "from ktrdr.cli.async_cli_client" ktrdr/
grep -r "from ktrdr.cli.api_client" ktrdr/
grep -r "from ktrdr.cli.operation_executor" ktrdr/

# All migrated commands must work:
ktrdr models train strategies/v3_minimal.yaml --start-date 2024-01-01 --end-date 2024-03-31
ktrdr data load AAPL --timeframe 1h --start 2024-01-01 --end 2024-03-31
ktrdr dummy dummy
```

**Success Criteria:**
- [ ] No old client imports in any command file
- [ ] All tests pass
- [ ] All affected commands work correctly

---

## Task 4.5.1: Migrate async_model_commands.py

**File(s):** `ktrdr/cli/async_model_commands.py`
**Type:** CODING
**Task Categories:** Migration

**Description:**
Migrate `async_model_commands.py` from old `AsyncOperationExecutor` to new `AsyncCLIClient.execute_operation()`.

**Current state:**
```python
from ktrdr.cli.operation_executor import AsyncOperationExecutor
from ktrdr.cli.operation_adapters import TrainingOperationAdapter

executor = AsyncOperationExecutor()
success = await executor.execute_operation(adapter, ...)
```

**Target state (from M4 handoff):**
```python
from ktrdr.cli.client import AsyncCLIClient, CLIClientError
from ktrdr.cli.operation_adapters import TrainingOperationAdapter

async with AsyncCLIClient() as cli:
    result = await cli.execute_operation(
        adapter,
        on_progress=on_progress,
        poll_interval=0.3,
    )
```

**Migration steps:**
1. Replace import: `operation_executor.AsyncOperationExecutor` → `client.AsyncCLIClient, CLIClientError`
2. Replace executor pattern with `async with AsyncCLIClient() as cli:` context manager
3. Replace `executor.execute_operation()` with `cli.execute_operation()`
4. Add `cli.health_check()` before operation
5. Handle result dict (status, result_summary) instead of boolean

**Gotchas (from M4 handoff):**
- Rich Progress callback needs `nonlocal task_id` pattern
- Result is dict with `status` field, not boolean
- Cancellation handled automatically via `asyncio.CancelledError`

**E2E Test:**
```bash
# Must complete successfully (not just start)
ktrdr models train strategies/v3_minimal.yaml --start-date 2024-01-01 --end-date 2024-03-31

# Expected: Training completes with progress bar, shows results or "completed" message
```

**Acceptance Criteria:**
- [ ] No imports from `operation_executor.py`
- [ ] Training command completes successfully
- [ ] Progress display works
- [ ] Ctrl+C cancellation works
- [ ] Unit tests pass

---

## Task 4.5.2: Migrate data_commands.py (data load)

**File(s):** `ktrdr/cli/data_commands.py`
**Type:** CODING
**Task Categories:** Migration

**Description:**
Migrate `data load` command from old `api_client.py` to new unified client.

**Current state:**
```python
from ktrdr.cli.api_client import check_api_connection, get_api_client

if not await check_api_connection():
    ...
api_client = get_api_client()
```

**Target state (from M2 handoff):**
```python
from ktrdr.cli.client import AsyncCLIClient, CLIClientError

async with AsyncCLIClient() as cli:
    if not await cli.health_check():
        ...
    result = await cli.post("/data/load", json=payload)
```

**Migration steps:**
1. Replace import: `api_client` imports → `client.AsyncCLIClient, CLIClientError`
2. Replace `check_api_connection()` with `cli.health_check()`
3. Replace `get_api_client()` calls with `cli.get/post()` methods
4. Update error handling to use `CLIClientError`
5. Remove any remaining `api_client` references

**Gotchas (from M2/M3 handoffs):**
- `health_check()` replaces `check_api_connection()`
- Use `client.config.base_url` for error URL display
- Parameter name is `json=` not `json_data=`

**E2E Test:**
```bash
# Requires IB host service running
ktrdr data load AAPL --timeframe 1h --start 2024-01-01 --end 2024-03-31

# Expected: Data loading completes (may fail at IB layer if no connection, but should not fail at client layer)
```

**Acceptance Criteria:**
- [ ] No imports from `api_client.py`
- [ ] `data load` command works (reaches API, proper error if IB unavailable)
- [ ] Unit tests pass

---

## Task 4.5.3: Migrate dummy_commands.py

**File(s):** `ktrdr/cli/dummy_commands.py`
**Type:** CODING
**Task Categories:** Migration

**Description:**
Migrate `dummy dummy` command from old clients to new unified client. This command uses BOTH old clients.

**Current state:**
```python
from ktrdr.cli.api_client import check_api_connection
from ktrdr.cli.operation_executor import AsyncOperationExecutor

if not await check_api_connection():
    ...
executor = AsyncOperationExecutor()
```

**Target state:**
```python
from ktrdr.cli.client import AsyncCLIClient, CLIClientError

async with AsyncCLIClient() as cli:
    if not await cli.health_check():
        ...
    result = await cli.execute_operation(adapter, ...)
```

**Migration steps:**
1. Replace both old imports with new client import
2. Replace `check_api_connection()` with `cli.health_check()`
3. Replace `AsyncOperationExecutor` with `AsyncCLIClient.execute_operation()`
4. Update result handling (dict with status, not boolean)

**E2E Test:**
```bash
ktrdr dummy dummy

# Expected: Dummy operation completes with progress display
```

**Acceptance Criteria:**
- [ ] No imports from `api_client.py`
- [ ] No imports from `operation_executor.py`
- [ ] `dummy dummy` command completes successfully
- [ ] Unit tests pass

---

## Task 4.5.4: Clean up model_commands.py

**File(s):** `ktrdr/cli/model_commands.py`
**Type:** CODING
**Task Categories:** Cleanup

**Description:**
The `model_commands.py` file is NOT wired to the CLI (`async_model_commands.py` is used instead). It contains unused code with mixed old/new imports. Delete or consolidate.

**Decision needed:**
- Option A: Delete `model_commands.py` entirely (if all functionality is in `async_model_commands.py`)
- Option B: Keep only non-duplicate parts, migrate remaining, wire up

**Pre-check:**
```bash
# Verify model_commands.py is not imported anywhere
grep -r "from ktrdr.cli.model_commands" ktrdr/
grep -r "model_commands" ktrdr/cli/__init__.py
```

**Acceptance Criteria:**
- [ ] No unused files with old client imports
- [ ] Clear single source for models commands

---

## Task 4.5.5: Final Verification

**Type:** TESTING
**Task Categories:** E2E

**Description:**
Verify all migrations complete and no old client imports remain.

**Verification steps:**

```bash
# 1. No old imports should remain
grep -r "from ktrdr.cli.async_cli_client" ktrdr/
grep -r "from ktrdr.cli.api_client" ktrdr/
grep -r "from ktrdr.cli.operation_executor" ktrdr/
# All should return nothing

# 2. Unit tests pass
make test-unit

# 3. Quality checks pass
make quality

# 4. E2E tests (require Docker + IB host service)
ktrdr models train strategies/v3_minimal.yaml --start-date 2024-01-01 --end-date 2024-03-31
ktrdr data load AAPL --timeframe 1h --start 2024-01-01 --end 2024-03-31
ktrdr dummy dummy
```

**Acceptance Criteria:**
- [ ] Zero grep matches for old client imports
- [ ] All unit tests pass
- [ ] All quality checks pass
- [ ] All E2E commands complete successfully

---

## Completion Checklist

- [ ] Task 4.5.1: `async_model_commands.py` migrated
- [ ] Task 4.5.2: `data_commands.py` (`data load`) migrated
- [ ] Task 4.5.3: `dummy_commands.py` migrated
- [ ] Task 4.5.4: `model_commands.py` cleaned up
- [ ] Task 4.5.5: Final verification passed
- [ ] No old client imports remain
- [ ] All tests pass
- [ ] Ready for M5 cleanup
