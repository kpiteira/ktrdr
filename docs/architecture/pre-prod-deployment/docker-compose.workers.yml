version: '3.8'

# =============================================================================
# KTRDR Worker Stack - Multi-Replica Ready
# =============================================================================
# Port Allocation Strategy (Sequential):
#   backtest-worker-1: 5003 (default)
#   backtest-worker-2: 5004 (scale-2 profile)
#   backtest-worker-3: 5007 (scale-3 profile)
#   training-worker-1: 5005 (default)
#   training-worker-2: 5006 (scale-2 profile)
#   training-worker-3: 5008 (scale-3 profile)
#
# Usage:
#   Default (1 of each):    docker compose up -d
#   Scale to 2 of each:     docker compose --profile scale-2 up -d
#   Scale to 3 of each:     docker compose --profile scale-2 --profile scale-3 up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backtest Workers
  # ---------------------------------------------------------------------------
  backtest-worker-1:
    image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: backtest-worker-1
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    ports:
      - "5003:5003"
    volumes:
      - /mnt/ktrdr-shared:/mnt/shared:ro
    environment:
      KTRDR_API_URL: http://backend.ktrdr.home.mynerd.place:8000
      WORKER_TYPE: backtesting
      WORKER_PORT: 5003
      WORKER_PUBLIC_BASE_URL: http://${WORKER_HOSTNAME:-workers-b.ktrdr.home.mynerd.place}:5003
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://backend.ktrdr.home.mynerd.place:4317
      # Database access for checkpointing
      DB_HOST: backend.ktrdr.home.mynerd.place
      DB_PORT: 5432
      DB_NAME: ktrdr
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    command: ["uvicorn", "ktrdr.backtesting.backtest_worker:app", "--host", "0.0.0.0", "--port", "5003"]
    networks:
      - ktrdr-workers

  backtest-worker-2:
    image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: backtest-worker-2
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    ports:
      - "5004:5004"
    volumes:
      - /mnt/ktrdr-shared:/mnt/shared:ro
    environment:
      KTRDR_API_URL: http://backend.ktrdr.home.mynerd.place:8000
      WORKER_TYPE: backtesting
      WORKER_PORT: 5004
      WORKER_PUBLIC_BASE_URL: http://${WORKER_HOSTNAME:-workers-b.ktrdr.home.mynerd.place}:5004
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://backend.ktrdr.home.mynerd.place:4317
      DB_HOST: backend.ktrdr.home.mynerd.place
      DB_PORT: 5432
      DB_NAME: ktrdr
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    command: ["uvicorn", "ktrdr.backtesting.backtest_worker:app", "--host", "0.0.0.0", "--port", "5004"]
    networks:
      - ktrdr-workers
    profiles:
      - scale-2

  backtest-worker-3:
    image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: backtest-worker-3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 3G
    ports:
      - "5007:5007"
    volumes:
      - /mnt/ktrdr-shared:/mnt/shared:ro
    environment:
      KTRDR_API_URL: http://backend.ktrdr.home.mynerd.place:8000
      WORKER_TYPE: backtesting
      WORKER_PORT: 5007
      WORKER_PUBLIC_BASE_URL: http://${WORKER_HOSTNAME:-workers-b.ktrdr.home.mynerd.place}:5007
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://backend.ktrdr.home.mynerd.place:4317
      DB_HOST: backend.ktrdr.home.mynerd.place
      DB_PORT: 5432
      DB_NAME: ktrdr
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    command: ["uvicorn", "ktrdr.backtesting.backtest_worker:app", "--host", "0.0.0.0", "--port", "5007"]
    networks:
      - ktrdr-workers
    profiles:
      - scale-3

  # ---------------------------------------------------------------------------
  # Training Workers
  # ---------------------------------------------------------------------------
  training-worker-1:
    image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: training-worker-1
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 5G
    ports:
      - "5005:5005"
    volumes:
      - /mnt/ktrdr-shared:/mnt/shared:rw
    environment:
      KTRDR_API_URL: http://backend.ktrdr.home.mynerd.place:8000
      WORKER_TYPE: training
      WORKER_PORT: 5005
      WORKER_PUBLIC_BASE_URL: http://${WORKER_HOSTNAME:-workers-b.ktrdr.home.mynerd.place}:5005
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://backend.ktrdr.home.mynerd.place:4317
      DB_HOST: backend.ktrdr.home.mynerd.place
      DB_PORT: 5432
      DB_NAME: ktrdr
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    command: ["uvicorn", "ktrdr.training.training_worker:app", "--host", "0.0.0.0", "--port", "5005"]
    networks:
      - ktrdr-workers

  training-worker-2:
    image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: training-worker-2
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 5G
    ports:
      - "5006:5006"
    volumes:
      - /mnt/ktrdr-shared:/mnt/shared:rw
    environment:
      KTRDR_API_URL: http://backend.ktrdr.home.mynerd.place:8000
      WORKER_TYPE: training
      WORKER_PORT: 5006
      WORKER_PUBLIC_BASE_URL: http://${WORKER_HOSTNAME:-workers-b.ktrdr.home.mynerd.place}:5006
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://backend.ktrdr.home.mynerd.place:4317
      DB_HOST: backend.ktrdr.home.mynerd.place
      DB_PORT: 5432
      DB_NAME: ktrdr
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    command: ["uvicorn", "ktrdr.training.training_worker:app", "--host", "0.0.0.0", "--port", "5006"]
    networks:
      - ktrdr-workers
    profiles:
      - scale-2

  training-worker-3:
    image: ghcr.io/kpiteira/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: training-worker-3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 5G
    ports:
      - "5008:5008"
    volumes:
      - /mnt/ktrdr-shared:/mnt/shared:rw
    environment:
      KTRDR_API_URL: http://backend.ktrdr.home.mynerd.place:8000
      WORKER_TYPE: training
      WORKER_PORT: 5008
      WORKER_PUBLIC_BASE_URL: http://${WORKER_HOSTNAME:-workers-b.ktrdr.home.mynerd.place}:5008
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://backend.ktrdr.home.mynerd.place:4317
      DB_HOST: backend.ktrdr.home.mynerd.place
      DB_PORT: 5432
      DB_NAME: ktrdr
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    command: ["uvicorn", "ktrdr.training.training_worker:app", "--host", "0.0.0.0", "--port", "5008"]
    networks:
      - ktrdr-workers
    profiles:
      - scale-3

networks:
  ktrdr-workers:
    driver: bridge

# =============================================================================
# Scaling Guide
# =============================================================================
#
# Start with 1 worker of each type (default):
#   docker compose up -d
#   Result: backtest-worker-1 (5003), training-worker-1 (5005)
#
# Scale to 2 workers of each type:
#   docker compose --profile scale-2 up -d
#   Result: backtest-worker-1 (5003), backtest-worker-2 (5004),
#           training-worker-1 (5005), training-worker-2 (5006)
#
# Scale to 3 workers of each type:
#   docker compose --profile scale-2 --profile scale-3 up -d
#   Result: All 6 workers (ports 5003-5008)
#
# Scale down from 3 to 2:
#   docker compose --profile scale-2 up -d
#   (Removes scale-3 workers)
#
# Scale down to 1:
#   docker compose up -d
#   (Removes scale-2 and scale-3 workers)
#
# Port Allocation Reference:
#   5003: backtest-worker-1 (default)
#   5004: backtest-worker-2 (scale-2)
#   5005: training-worker-1 (default)
#   5006: training-worker-2 (scale-2)
#   5007: backtest-worker-3 (scale-3)
#   5008: training-worker-3 (scale-3)
#
# Each worker self-registers with backend using WORKER_PUBLIC_BASE_URL.
# Backend queries workers via these URLs for status and metrics.
# Prometheus scrapes all active worker ports (update prometheus.yml when scaling).
# =============================================================================
