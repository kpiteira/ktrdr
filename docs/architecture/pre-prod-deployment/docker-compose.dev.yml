version: '3.8'

# =============================================================================
# KTRDR Local Development Environment (Mac)
# =============================================================================
# This compose file is optimized for local development with:
# - Hot reload (bind-mounted code)
# - Simplified networking (single host)
# - Optional image mode for pre-deployment testing
#
# Quick Start:
#   1. Copy .env.core.example to .env.dev and fill in values
#   2. docker compose -f docker-compose.dev.yml up
#   3. Access backend at http://localhost:8000
#
# See design-input.md Section 5 for detailed local dev workflow.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Database
  # ---------------------------------------------------------------------------
  db:
    image: timescale/timescaledb-ha:pg15
    container_name: ktrdr-db-dev
    restart: unless-stopped
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${DB_NAME:-ktrdr}
      POSTGRES_USER: ${DB_USER:-ktrdr_dev}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dev_password}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ktrdr_dev}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ktrdr-dev

  # ---------------------------------------------------------------------------
  # Backend API (Hot Reload Mode)
  # ---------------------------------------------------------------------------
  backend:
    # Hot reload mode (default): bind mount code
    build:
      context: ../../../
      dockerfile: docker/backend/Dockerfile
      target: builder  # Use builder stage for dev dependencies
    # Image mode (testing): uncomment to test with built images
    # image: ghcr.io/<github-username>/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: ktrdr-backend-dev
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # Bind mount source code for hot reload
      - ../../../ktrdr:/app/ktrdr:ro
      # Shared storage (use local directory for dev)
      - ./dev-shared:/mnt/shared
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-ktrdr}
      DB_USER: ${DB_USER:-ktrdr_dev}
      DB_PASSWORD: ${DB_PASSWORD:-dev_password}
      JWT_SECRET: ${JWT_SECRET:-dev_jwt_secret_at_least_32_chars_long}
      KTRDR_API_HOST: 0.0.0.0
      KTRDR_API_PORT: 8000
      ENVIRONMENT: development
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      OTLP_ENDPOINT: http://jaeger:4317
      SHARED_MOUNT_PATH: /mnt/shared
      # Development-specific
      USE_HOT_RELOAD: "true"
      DEV_MODE: "true"
    command: ["uvicorn", "ktrdr.api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    depends_on:
      db:
        condition: service_healthy
    networks:
      - ktrdr-dev

  # ---------------------------------------------------------------------------
  # Prometheus (Metrics)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: ktrdr-prometheus-dev
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus-dev.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data_dev:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'  # Shorter retention for dev
    networks:
      - ktrdr-dev

  # ---------------------------------------------------------------------------
  # Grafana (Dashboards)
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: ktrdr-grafana-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GF_ADMIN_PASSWORD:-admin}
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    volumes:
      - ./monitoring/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./monitoring/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data_dev:/var/lib/grafana
    depends_on:
      - prometheus
      - jaeger
    networks:
      - ktrdr-dev

  # ---------------------------------------------------------------------------
  # Jaeger (Tracing)
  # ---------------------------------------------------------------------------
  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: ktrdr-jaeger-dev
    restart: unless-stopped
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
      SPAN_STORAGE_TYPE: memory
    networks:
      - ktrdr-dev

  # ---------------------------------------------------------------------------
  # Backtest Worker (Optional - for local testing)
  # ---------------------------------------------------------------------------
  backtest-worker:
    # Same image as backend (workers are part of backend codebase)
    build:
      context: ../../../
      dockerfile: docker/backend/Dockerfile
      target: builder
    # Image mode: uncomment to test with built images
    # image: ghcr.io/<github-username>/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: ktrdr-backtest-worker-dev
    restart: unless-stopped
    ports:
      - "5003:5003"
    volumes:
      - ../../../ktrdr:/app/ktrdr:ro
      - ./dev-shared:/mnt/shared:ro
    environment:
      KTRDR_API_URL: http://backend:8000
      WORKER_TYPE: backtesting
      WORKER_PORT: 5003
      WORKER_PUBLIC_BASE_URL: http://localhost:5003
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://jaeger:4317
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-ktrdr}
      DB_USER: ${DB_USER:-ktrdr_dev}
      DB_PASSWORD: ${DB_PASSWORD:-dev_password}
    command: ["uvicorn", "ktrdr.backtesting.backtest_worker:app", "--host", "0.0.0.0", "--port", "5003", "--reload"]
    depends_on:
      - backend
      - db
    networks:
      - ktrdr-dev
    profiles:
      - workers  # Only start with: docker compose --profile workers up

  # ---------------------------------------------------------------------------
  # Training Worker (Optional - for local testing)
  # ---------------------------------------------------------------------------
  training-worker:
    build:
      context: ../../../
      dockerfile: docker/backend/Dockerfile
      target: builder
    # Image mode: uncomment to test with built images
    # image: ghcr.io/<github-username>/ktrdr-backend:${IMAGE_TAG:-latest}
    container_name: ktrdr-training-worker-dev
    restart: unless-stopped
    ports:
      - "5004:5004"
    volumes:
      - ../../../ktrdr:/app/ktrdr:ro
      - ./dev-shared:/mnt/shared:rw
    environment:
      KTRDR_API_URL: http://backend:8000
      WORKER_TYPE: training
      WORKER_PORT: 5004
      WORKER_PUBLIC_BASE_URL: http://localhost:5004
      SHARED_MOUNT_PATH: /mnt/shared
      OTLP_ENDPOINT: http://jaeger:4317
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-ktrdr}
      DB_USER: ${DB_USER:-ktrdr_dev}
      DB_PASSWORD: ${DB_PASSWORD:-dev_password}
    command: ["uvicorn", "ktrdr.training.training_worker:app", "--host", "0.0.0.0", "--port", "5004", "--reload"]
    depends_on:
      - backend
      - db
    networks:
      - ktrdr-dev
    profiles:
      - workers  # Only start with: docker compose --profile workers up

networks:
  ktrdr-dev:
    driver: bridge

volumes:
  postgres_data_dev:
  prometheus_data_dev:
  grafana_data_dev:

# =============================================================================
# Usage Examples
# =============================================================================
#
# Start core services only (backend, db, observability):
#   docker compose -f docker-compose.dev.yml up
#
# Start with workers for distributed testing:
#   docker compose -f docker-compose.dev.yml --profile workers up
#
# Rebuild backend after dependency changes:
#   docker compose -f docker-compose.dev.yml build backend
#
# View logs:
#   docker compose -f docker-compose.dev.yml logs -f backend
#
# Test with built images (switch to image mode):
#   1. Comment out 'build:' sections
#   2. Uncomment 'image:' lines
#   3. Build images: make build-backend TAG=local
#   4. docker compose -f docker-compose.dev.yml up
#
# =============================================================================
