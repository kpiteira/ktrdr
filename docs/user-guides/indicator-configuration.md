# Indicator Configuration Guide

## Overview

This guide explains how to configure technical indicators in KTRDR strategy files with **feature IDs** - the stable identifiers that connect indicators to fuzzy sets and neural network features.

## Core Concepts

### 1. Indicator Type

The class/category of indicator being used.

**Field**: `name` in strategy YAML

**Examples**: `"rsi"`, `"ema"`, `"macd"`

### 2. Feature ID (User-Facing Identifier)

A stable, unique identifier that connects indicators to fuzzy sets and features.

**Field**: `feature_id` in strategy YAML (**REQUIRED**)

**Examples**:
- `"rsi_14"` (using parameters for distinction)
- `"rsi_fast"` (descriptive name)
- `"macd_standard"` (semantic name)
- `"macd_12_26_9"` (explicit parameters)

**Rules**:
- **MANDATORY** - no defaults allowed
- **MUST BE UNIQUE** within strategy
- **CAN use parameters** for distinction (recommended for clarity)
- **CAN be descriptive** (optional for readability)

### 3. Column Name (Implementation Detail)

Technical identifier in pandas DataFrame (auto-generated by indicator).

**Generated by**: `indicator.get_column_name()`

**Examples**: `"rsi_14"`, `"ema_20"`, `"MACD_12_26"`

**Note**: This is an internal implementation detail. You should reference indicators by their `feature_id` in fuzzy sets and training configuration.

## Feature ID Requirements

### Format Validation

Feature IDs must follow this pattern: `^[a-zA-Z][a-zA-Z0-9_-]*$`

- **Must start** with a letter
- **Can contain**: letters, numbers, underscore (`_`), dash (`-`)
- **Cannot start** with number or special character

**Valid Examples**:
```yaml
feature_id: rsi_14        ✅ Good
feature_id: rsi-fast      ✅ Good
feature_id: MACD_standard ✅ Good
feature_id: ema50         ✅ Good
```

**Invalid Examples**:
```yaml
feature_id: 14_rsi        ❌ Starts with number
feature_id: rsi.fast      ❌ Contains dot
feature_id: rsi fast      ❌ Contains space
feature_id: close         ❌ Reserved word
```

### Reserved Words

These are reserved for price data columns and cannot be used as feature IDs:

- `open`
- `high`
- `low`
- `close`
- `volume`

### Uniqueness

All feature IDs within a strategy **MUST BE UNIQUE**. Duplicate feature IDs will cause a validation error.

## Feature ID Naming Strategies

### Pattern 1: Parameter-Based (Recommended for Clarity)

Include indicator parameters in the feature ID to make it self-documenting:

```yaml
indicators:
  - name: "rsi"
    feature_id: "rsi_14"  # Includes period parameter
    period: 14

  - name: "rsi"
    feature_id: "rsi_21"  # Different period = different feature_id
    period: 21

  - name: "macd"
    feature_id: "macd_12_26_9"  # All parameters included
    fast_period: 12
    slow_period: 26
    signal_period: 9
```

**Pros**: Clear, unambiguous, matches common convention
**Use when**: You have multiple instances of the same indicator type

### Pattern 2: Semantic/Descriptive (Recommended for Readability)

Use meaningful names that describe the indicator's purpose:

```yaml
indicators:
  - name: "rsi"
    feature_id: "rsi_fast"  # Describes role
    period: 7

  - name: "rsi"
    feature_id: "rsi_slow"  # Describes role
    period: 21

  - name: "macd"
    feature_id: "macd_trend"  # Semantic meaning
    fast_period: 12
    slow_period: 26
    signal_period: 9

  - name: "ema"
    feature_id: "ema_short"  # Relative description
    period: 9
```

**Pros**: Readable, expresses strategy intent
**Use when**: Parameter values are less important than role/purpose

### Pattern 3: Mixed (Most Common in Practice)

Combine parameter-based and semantic naming:

```yaml
indicators:
  - name: "rsi"
    feature_id: "rsi_14"  # Parameter-based for standard RSI
    period: 14

  - name: "macd"
    feature_id: "macd_trend"  # Semantic for main MACD
    fast_period: 12
    slow_period: 26
    signal_period: 9

  - name: "ema"
    feature_id: "ema_short"  # Semantic for moving average
    period: 9

  - name: "bbands"
    feature_id: "bbands_20_2"  # Parameters for Bollinger Bands
    period: 20
    num_std: 2.0
```

**Pros**: Flexible, optimizes for both clarity and meaning
**Use when**: You want the best of both approaches

## Complete Configuration Example

Here's a complete indicator configuration with feature IDs:

```yaml
# === TECHNICAL INDICATORS ===
indicators:
  # RSI for overbought/oversold detection
  - name: "rsi"
    feature_id: "rsi_14"  # Standard 14-period RSI
    period: 14
    source: "close"

  # Fast RSI for early signals
  - name: "rsi"
    feature_id: "rsi_fast"  # Faster RSI for quick reactions
    period: 7
    source: "close"

  # MACD for trend confirmation
  - name: "macd"
    feature_id: "macd_standard"  # Standard MACD settings
    fast_period: 12
    slow_period: 26
    signal_period: 9
    source: "close"

  # Moving average for trend filter
  - name: "ema"
    feature_id: "ema_trend"  # Long-term trend filter
    period: 50
    source: "close"

# === FUZZY LOGIC CONFIGURATION ===
# Note: fuzzy_sets keys MUST match feature_ids
fuzzy_sets:
  rsi_14:  # Matches feature_id "rsi_14"
    oversold:
      type: "triangular"
      parameters: [0, 20, 35]
    neutral:
      type: "triangular"
      parameters: [30, 50, 70]
    overbought:
      type: "triangular"
      parameters: [65, 80, 100]

  rsi_fast:  # Matches feature_id "rsi_fast"
    extreme_oversold:
      type: "triangular"
      parameters: [0, 10, 25]
    extreme_overbought:
      type: "triangular"
      parameters: [75, 90, 100]

  macd_standard:  # Matches feature_id "macd_standard"
    strong_bearish:
      type: "triangular"
      parameters: [-100, -50, -10]
    bearish:
      type: "triangular"
      parameters: [-20, -5, 0]
    neutral:
      type: "triangular"
      parameters: [-5, 0, 5]
    bullish:
      type: "triangular"
      parameters: [0, 5, 20]
    strong_bullish:
      type: "triangular"
      parameters: [10, 50, 100]
```

## Multi-Output Indicators

Some indicators produce multiple output columns (e.g., MACD produces main line, signal line, and histogram).

### Primary Output Mapping

For multi-output indicators, the **feature_id maps to the primary output** only:

```yaml
indicators:
  - name: "macd"
    feature_id: "macd_12_26_9"
    fast_period: 12
    slow_period: 26
    signal_period: 9

# DataFrame columns created:
# - MACD_12_26 (main line) ← PRIMARY OUTPUT
# - MACD_signal_12_26_9 (signal line)
# - MACD_hist_12_26_9 (histogram)
#
# feature_id "macd_12_26_9" → maps to MACD_12_26 (primary output)
```

### Current Multi-Output Behavior

**MACD**: Primary output is the main MACD line (currently only this is fuzzified)

```yaml
fuzzy_sets:
  macd_12_26_9:  # References primary output (main line)
    bullish:
      type: "triangular"
      parameters: [0, 5, 20]
```

**Other multi-output indicators**: Follow the same pattern - feature_id maps to primary/main output.

## Validation

### Config Load Validation

When a strategy is loaded, these validations occur:

1. **feature_id presence**: All indicators MUST have a feature_id field
2. **feature_id format**: Must match pattern `^[a-zA-Z][a-zA-Z0-9_-]*$`
3. **Reserved words**: feature_id cannot be a reserved word
4. **Uniqueness**: No duplicate feature_ids within the strategy

### Strategy Validation

After config load, additional semantic checks:

1. **Fuzzy set matching** (STRICT): Every feature_id MUST have a corresponding fuzzy_sets entry
2. **Orphaned fuzzy sets** (WARNING): Fuzzy sets without matching feature_id (may be intentional for derived features)

### Example Validation Error

```
❌ Validation Error: Missing required field 'feature_id'

Location: indicators[0]
Field: feature_id

Details:
  - Indicator type: rsi
  - Missing feature_id (REQUIRED since v2.1)

Suggestion:
  Add 'feature_id' to indicator:

  indicators:
    - name: "rsi"
      feature_id: "rsi_14"  # ADD THIS
      period: 14
```

## Migration from Old Format

If you have strategies without feature_ids (old format), use the migration tool:

```bash
# Preview migration (dry-run)
python scripts/migrate_to_feature_ids.py strategy.yaml --dry-run

# Migrate strategy (creates backup)
python scripts/migrate_to_feature_ids.py strategy.yaml --backup

# Migrate all strategies
python scripts/migrate_to_feature_ids.py strategies/*.yaml
```

The migration tool:
- Automatically generates feature_ids from column names
- Preserves existing fuzzy set configurations
- Validates uniqueness
- Detects collisions and provides clear errors

## Best Practices

1. **Be Consistent**: Pick a naming strategy (parameter-based, semantic, or mixed) and stick with it

2. **Be Explicit**: Always provide feature_id - never rely on defaults (there are none!)

3. **Be Descriptive**: Choose feature_ids that make your strategy intent clear

4. **Match Fuzzy Sets**: Ensure every feature_id has a corresponding fuzzy_sets entry

5. **Validate Early**: Run validation before training to catch configuration issues

6. **Document Intent**: Use comments to explain why you chose specific feature_ids

## Common Errors and Solutions

### Error: "Duplicate feature_id"

```yaml
# ❌ WRONG - duplicate feature_ids
indicators:
  - name: "rsi"
    feature_id: "rsi"  # ← Duplicate!
    period: 14
  - name: "rsi"
    feature_id: "rsi"  # ← Duplicate!
    period: 21

# ✅ CORRECT - unique feature_ids
indicators:
  - name: "rsi"
    feature_id: "rsi_14"  # ← Unique!
    period: 14
  - name: "rsi"
    feature_id: "rsi_21"  # ← Unique!
    period: 21
```

### Error: "Missing fuzzy_sets entry"

```yaml
# ❌ WRONG - feature_id without fuzzy sets
indicators:
  - name: "rsi"
    feature_id: "rsi_14"
    period: 14

fuzzy_sets:
  # Missing rsi_14 entry!

# ✅ CORRECT - fuzzy sets match feature_id
indicators:
  - name: "rsi"
    feature_id: "rsi_14"
    period: 14

fuzzy_sets:
  rsi_14:  # ← Matches feature_id
    oversold:
      type: "triangular"
      parameters: [0, 20, 35]
```

### Error: "Invalid feature_id format"

```yaml
# ❌ WRONG - starts with number
indicators:
  - name: "rsi"
    feature_id: "14_rsi"  # ← Invalid!
    period: 14

# ✅ CORRECT - starts with letter
indicators:
  - name: "rsi"
    feature_id: "rsi_14"  # ← Valid!
    period: 14
```

## Summary

- **feature_id is REQUIRED** for all indicators
- **feature_id must be UNIQUE** within each strategy
- **Feature IDs connect** indicators → fuzzy sets → neural features
- **Validation is STRICT** to catch errors early
- **Use migration tool** to upgrade old strategies
- **Choose clear names** that make strategy intent obvious

For more details, see:
- [Architecture Document](../architecture/indicators/explicit-naming-architecture.md)
- [Migration Guide](../migration/feature-ids-migration-guide.md)
- [Strategy Management Guide](./strategy-management.md)
