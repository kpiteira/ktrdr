version: "3.8"

# Distributed Workers Development Environment
# This docker-compose file is for developing and testing the distributed workers architecture
# For production, workers will run in Proxmox LXC containers

services:
  # Backend service - Central orchestrator
  backend:
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile.dev
    image: ktrdr-backend:dev
    container_name: ktrdr-backend-distributed
    ports:
      - "8000:8000"
    volumes:
      # Mount source code for hot-reloading
      - ../ktrdr:/app/ktrdr
      - ../tests:/app/tests
      - ../data:/app/data
      - ../logs:/app/logs
      - ../config:/app/config:ro
      - ../strategies:/app/strategies:ro
      - ../models:/app/models
      # Cache directories
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
      - ENVIRONMENT=development
      # OpenTelemetry / Jaeger configuration (Phase 2: Jaeger UI)
      - OTLP_ENDPOINT=http://jaeger:4317
      # Enable distributed workers architecture
      - USE_IB_HOST_SERVICE=false
      - USE_TRAINING_HOST_SERVICE=false
      - USE_REMOTE_BACKTEST_SERVICE=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      jaeger:
        condition: service_healthy
    command: ["uvicorn", "ktrdr.api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  # Backtest worker - Executes backtesting operations
  # Can be scaled with: docker-compose -f docker/docker-compose.dev.yml up -d --scale backtest-worker=3
  backtest-worker:
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile.dev
    image: ktrdr-backend:dev
    ports:
      - "5003"  # Dynamic port mapping for scaling
    volumes:
      - ../ktrdr:/app/ktrdr
      - ../data:/app/data:ro
      - ../models:/app/models:ro
      - ../strategies:/app/strategies:ro
      - ../config:/app/config:ro
      - ../logs:/app/logs
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
      - KTRDR_API_URL=http://backend:8000
      - WORKER_TYPE=backtesting
      - WORKER_PORT=5003
      # Worker ID will be auto-generated from hostname
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      backend:
        condition: service_healthy
    # Run the backtesting worker API (using WorkerAPIBase pattern)
    command: ["uvicorn", "ktrdr.backtesting.backtest_worker:app", "--host", "0.0.0.0", "--port", "5003", "--reload"]

  # Training worker - Executes training operations
  # Can be scaled with: docker-compose -f docker/docker-compose.dev.yml up -d --scale training-worker=2
  training-worker:
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile.dev
    image: ktrdr-backend:dev
    ports:
      - "5004"  # Dynamic port mapping for scaling
    volumes:
      - ../ktrdr:/app/ktrdr
      - ../data:/app/data:ro
      - ../models:/app/models
      - ../strategies:/app/strategies:ro
      - ../config:/app/config:ro
      - ../logs:/app/logs
      - pip-cache:/root/.cache/pip
      - uv-cache:/root/.cache/uv
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
      - KTRDR_API_URL=http://backend:8000
      - WORKER_TYPE=training
      - WORKER_PORT=5004
      # Worker ID will be auto-generated from hostname
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ktrdr-network
    depends_on:
      backend:
        condition: service_healthy
    # Run the training worker API (using WorkerAPIBase pattern)
    command: ["uvicorn", "ktrdr.training.training_worker:app", "--host", "0.0.0.0", "--port", "5004", "--reload"]

  # Jaeger - Distributed tracing UI and collector (Phase 2: Jaeger UI)
  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: ktrdr-jaeger
    restart: unless-stopped
    ports:
      # Jaeger UI
      - "16686:16686"
      # OTLP gRPC receiver (for OpenTelemetry traces)
      - "4317:4317"
      # OTLP HTTP receiver (alternative)
      - "4318:4318"
      # Jaeger agent (legacy, for completeness)
      - "6831:6831/udp"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Prometheus - Metrics collection (Phase 5: Metrics and Dashboards)
  prometheus:
    image: prom/prometheus:latest
    container_name: ktrdr-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Grafana - Unified observability UI (Phase 5: Metrics and Dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: ktrdr-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_INSTALL_PLUGINS=
    volumes:
      - ../monitoring/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ../monitoring/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ../monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - jaeger
    networks:
      - ktrdr-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  ktrdr-network:
    driver: bridge

volumes:
  pip-cache:
  uv-cache:
  prometheus_data:
  grafana_data:
