<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTRDR - Lightweight Charts PoC</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #151924;
            color: #d1d4dc;
        }
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .chart-container {
            height: 400px;  /* Main price chart is taller */
            margin-bottom: 10px;
            border: 1px solid #2a2e39;
            border-radius: 4px;
        }
        .subchart-container {
            height: 150px;  /* Indicator charts are shorter */
            margin-bottom: 10px;
            border: 1px solid #2a2e39;
            border-radius: 4px;
        }
        .range-container {
            height: 60px;  /* Compact range slider */
            margin-bottom: 10px;
            border: 1px solid #2a2e39;
            border-radius: 4px;
        }
        h1, h2 {
            color: #d1d4dc;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        button {
            background-color: #2962ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0039cb;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 5px 0;
            padding: 5px;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>KTRDR Technical Analysis Chart</h1>
            <div class="controls">
                <button id="darkTheme" disabled>Dark Theme</button>
                <button id="lightTheme">Light Theme</button>
            </div>
        </div>

        <div id="status" class="status">Loading charts...</div>

        <!-- Price Chart with SMA and EMA -->
        <h2>Price Chart</h2>
        <div class="legend" id="priceLegend"></div>
        <div class="chart-container" id="priceChart"></div>
        
        <!-- Volume Chart -->
        <h2>Volume</h2>
        <div class="subchart-container" id="volumeChart"></div>
        
        <!-- RSI Chart -->
        <h2>RSI (14)</h2>
        <div class="subchart-container" id="rsiChart"></div>
        
        <!-- MACD Chart -->
        <h2>MACD (12,26,9)</h2>
        <div class="legend" id="macdLegend"></div>
        <div class="subchart-container" id="macdChart"></div>
        
        <!-- Range Slider Chart -->
        <h2>Range Selector</h2>
        <div class="range-container" id="rangeChart"></div>
    </div>
    
    <script>
        // Simple status update function
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }
        
        // Show loading message
        updateStatus('Initializing charts...');

        // Sample data generation
        function generateSampleData(days = 70, startPrice = 150.0) {
            const data = [];
            let price = startPrice;
            
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Start of today
            
            for (let i = days; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                
                // Create some price movement
                const changePercent = (Math.random() * 4 - 2) / 100; // -2% to +2%
                const open = price;
                const close = Math.max(price * (1 + changePercent), 0.1);
                const high = Math.max(open, close) * (1 + Math.random() * 0.01);
                const low = Math.min(open, close) * (1 - Math.random() * 0.01);
                const volume = Math.floor(Math.random() * 30000000) + 10000000;
                
                data.push({
                    time: Math.floor(date.getTime() / 1000),
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)), 
                    close: parseFloat(close.toFixed(2)),
                    volume: volume
                });
                
                price = close; // Set next day's opening price
            }
            
            updateStatus('Sample data generated');
            return data;
        }
        
        // Chart instances
        let priceChart, volumeChart, rsiChart, macdChart, rangeChart;
        let priceSeries, volumeSeries, rsiSeries, macdLineSeries, signalLineSeries, histSeries;
        let sma20Series, ema10Series;
        
        // Chart configuration
        const darkTheme = {
            layout: {
                background: { color: '#151924' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2a2e39' },
                horzLines: { color: '#2a2e39' },
            },
            crosshair: {
                vertLine: {
                    color: '#758696',
                    width: 1,
                    style: 1,
                },
                horzLine: {
                    color: '#758696',
                    width: 1,
                    style: 1,
                },
            }
        };
        
        const lightTheme = {
            layout: {
                background: { color: '#ffffff' },
                textColor: '#333333',
            },
            grid: {
                vertLines: { color: '#e6e6e6' },
                horzLines: { color: '#e6e6e6' },
            },
            crosshair: {
                vertLine: {
                    color: '#999999',
                    width: 1,
                    style: 1,
                },
                horzLine: {
                    color: '#999999',
                    width: 1,
                    style: 1,
                },
            }
        };
        
        // Function to apply theme to all charts
        function applyTheme(theme) {
            const chartInstances = [priceChart, volumeChart, rsiChart, macdChart, rangeChart];
            chartInstances.forEach(chart => {
                if (chart) {
                    chart.applyOptions({
                        layout: theme.layout,
                        grid: theme.grid,
                        crosshair: theme.crosshair,
                    });
                }
            });
            
            // Update text colors for legends
            document.body.style.backgroundColor = theme.layout.background.color;
            document.body.style.color = theme.layout.textColor;
            
            const headings = document.querySelectorAll('h1, h2');
            headings.forEach(h => h.style.color = theme.layout.textColor);
        }
        
        // Theme button handlers
        document.getElementById('darkTheme').addEventListener('click', () => {
            applyTheme(darkTheme);
            document.getElementById('darkTheme').disabled = true;
            document.getElementById('lightTheme').disabled = false;
        });
        
        document.getElementById('lightTheme').addEventListener('click', () => {
            applyTheme(lightTheme);
            document.getElementById('lightTheme').disabled = true;
            document.getElementById('darkTheme').disabled = false;
        });
        
        // Load and prepare data
        function setupCharts() {
            updateStatus('Setting up charts...');
            
            try {
                // Generate sample data
                const ohlcData = generateSampleData(70, 150.0);
                
                // Format volume data
                const volumeData = ohlcData.map(item => ({
                    time: item.time,
                    value: item.volume,
                    color: item.close >= item.open ? '#26a69a' : '#ef5350'
                }));
                
                // Calculate indicators
                const smaData = calculateSMA(ohlcData, 20);
                const emaData = calculateEMA(ohlcData, 10);
                const rsiData = calculateRSI(ohlcData, 14);
                const macdData = calculateMACD(ohlcData, 12, 26, 9);
                
                // Create RSI oversold/overbought lines
                const oversoldLine = ohlcData.map(data => ({ time: data.time, value: 30 }));
                const overboughtLine = ohlcData.map(data => ({ time: data.time, value: 70 }));
                
                // Initialize charts and set data
                updateStatus('Initializing charts...');
                const series = initCharts();
                
                updateStatus('Applying data to charts...');
                
                // Set data for each series
                series.priceSeries.setData(ohlcData);
                series.sma20Series.setData(smaData);
                series.ema10Series.setData(emaData);
                series.volumeSeries.setData(volumeData);
                series.rsiSeries.setData(rsiData);
                series.macdLineSeries.setData(macdData.macdLine);
                series.signalLineSeries.setData(macdData.signalLine);
                series.histSeries.setData(macdData.histogram);
                series.rangeSeries.setData(ohlcData.map(d => ({ time: d.time, value: d.close })));
                series.rsiOverSold.setData(oversoldLine);
                series.rsiOverBought.setData(overboughtLine);
                
                // Fit content to view
                updateStatus('Fitting content to view...');
                priceChart.timeScale().fitContent();
                rangeChart.timeScale().fitContent();
                
                updateStatus('Charts loaded successfully!');
                setTimeout(() => {
                    document.getElementById('status').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Error setting up charts:', error);
                updateStatus('Error setting up charts: ' + error.message);
            }
        }
        
        // Initialize charts
        function initCharts() {
            try {
                updateStatus('Creating price chart...');
                // Create price chart
                priceChart = LightweightCharts.createChart(document.getElementById('priceChart'), {
                    ...darkTheme,
                    timeScale: {
                        timeVisible: true,
                        borderColor: '#2a2e39',
                    },
                    rightPriceScale: {
                        borderColor: '#2a2e39',
                    },
                    handleScroll: {
                        mouseWheel: true,
                        pressedMouseMove: true,
                    },
                    handleScale: {
                        mouseWheel: true,
                        pinch: true,
                    },
                });
                
                // Create candlestick series
                priceSeries = priceChart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                });
                
                // Create SMA 20 series
                sma20Series = priceChart.addLineSeries({
                    color: '#2962FF',
                    lineWidth: 1.5,
                    title: 'SMA 20',
                });
                
                // Create EMA 10 series
                ema10Series = priceChart.addLineSeries({
                    color: '#FF6D00',
                    lineWidth: 1.5,
                    title: 'EMA 10',
                });
                
                updateStatus('Creating volume chart...');
                // Create volume chart
                volumeChart = LightweightCharts.createChart(document.getElementById('volumeChart'), {
                    ...darkTheme,
                    timeScale: {
                        visible: false,
                    },
                    rightPriceScale: {
                        scaleMargins: {
                            top: 0.1,
                            bottom: 0.1,
                        },
                        borderColor: '#2a2e39',
                    },
                    handleScroll: false,
                    handleScale: false,
                });
                
                // Create volume series
                volumeSeries = volumeChart.addHistogramSeries({
                    color: '#26a69a',
                    priceFormat: {
                        type: 'volume',
                    },
                    priceScaleId: '',
                });
                
                updateStatus('Creating RSI chart...');
                // Create RSI chart
                rsiChart = LightweightCharts.createChart(document.getElementById('rsiChart'), {
                    ...darkTheme,
                    timeScale: {
                        visible: false,
                    },
                    rightPriceScale: {
                        scaleMargins: {
                            top: 0.1,
                            bottom: 0.1,
                        },
                        borderColor: '#2a2e39',
                    },
                    handleScroll: false,
                    handleScale: false,
                });
                
                // Create RSI series
                rsiSeries = rsiChart.addLineSeries({
                    color: '#E91E63',
                    lineWidth: 1.5,
                    title: 'RSI (14)',
                });
                
                // Add RSI reference lines at 70 and 30
                const rsiOverSold = rsiChart.addLineSeries({
                    color: 'rgba(255, 255, 255, 0.5)',
                    lineWidth: 1,
                    lineStyle: 2, // Dashed
                });
                
                const rsiOverBought = rsiChart.addLineSeries({
                    color: 'rgba(255, 255, 255, 0.5)',
                    lineWidth: 1,
                    lineStyle: 2, // Dashed
                });
                
                updateStatus('Creating MACD chart...');
                // Create MACD chart
                macdChart = LightweightCharts.createChart(document.getElementById('macdChart'), {
                    ...darkTheme,
                    timeScale: {
                        visible: false,
                    },
                    rightPriceScale: {
                        scaleMargins: {
                            top: 0.1,
                            bottom: 0.1,
                        },
                        borderColor: '#2a2e39',
                    },
                    handleScroll: false,
                    handleScale: false,
                });
                
                // Create MACD series
                macdLineSeries = macdChart.addLineSeries({
                    color: '#2962FF',
                    lineWidth: 1.5,
                    title: 'MACD Line',
                });
                
                signalLineSeries = macdChart.addLineSeries({
                    color: '#FF6D00',
                    lineWidth: 1.5,
                    title: 'Signal Line',
                });
                
                histSeries = macdChart.addHistogramSeries({
                    color: '#26a69a',
                    priceLineVisible: false,
                    lastValueVisible: false,
                });
                
                updateStatus('Creating range slider...');
                // Create range chart (for navigation)
                rangeChart = LightweightCharts.createChart(document.getElementById('rangeChart'), {
                    ...darkTheme,
                    timeScale: {
                        timeVisible: true,
                        borderColor: '#2a2e39',
                    },
                    rightPriceScale: {
                        visible: false,
                    },
                    handleScroll: true,
                    handleScale: true,
                });
                
                // Create simple line series for the range chart
                const rangeSeries = rangeChart.addLineSeries({
                    color: 'rgba(41, 98, 255, 0.7)',
                    lineWidth: 1,
                });
                
                updateStatus('Synchronizing charts...');
                // Synchronize charts with range chart
                rangeChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                    if (range) {
                        priceChart.timeScale().setVisibleLogicalRange(range);
                    }
                });
                
                priceChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                    if (range) {
                        volumeChart.timeScale().setVisibleLogicalRange(range);
                        rsiChart.timeScale().setVisibleLogicalRange(range);
                        macdChart.timeScale().setVisibleLogicalRange(range);
                    }
                });
                
                // Setup legends
                setupLegend();
                
                return {
                    priceSeries,
                    sma20Series,
                    ema10Series,
                    volumeSeries,
                    rsiSeries,
                    macdLineSeries,
                    signalLineSeries,
                    histSeries,
                    rangeSeries,
                    rsiOverSold,
                    rsiOverBought
                };
            } catch (error) {
                console.error('Error initializing charts:', error);
                updateStatus('Error initializing charts: ' + error.message);
                throw error;
            }
        }
        
        // Setup legend with dynamic values
        function setupLegend() {
            const priceLegend = document.getElementById('priceLegend');
            const macdLegend = document.getElementById('macdLegend');
            
            priceLegend.innerHTML = `
                <div class="legend-item">
                    <span class="color-dot" style="background-color: white;"></span>
                    <span>Price</span>
                </div>
                <div class="legend-item">
                    <span class="color-dot" style="background-color: #2962FF;"></span>
                    <span>SMA (20)</span>
                </div>
                <div class="legend-item">
                    <span class="color-dot" style="background-color: #FF6D00;"></span>
                    <span>EMA (10)</span>
                </div>
            `;
            
            macdLegend.innerHTML = `
                <div class="legend-item">
                    <span class="color-dot" style="background-color: #2962FF;"></span>
                    <span>MACD Line (12,26)</span>
                </div>
                <div class="legend-item">
                    <span class="color-dot" style="background-color: #FF6D00;"></span>
                    <span>Signal (9)</span>
                </div>
                <div class="legend-item">
                    <span class="color-dot" style="background-color: #26a69a;"></span>
                    <span>Histogram</span>
                </div>
            `;
        }
        
        // Calculate Simple Moving Average
        function calculateSMA(data, period) {
            const smaData = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    // Not enough data yet
                    continue;
                }
                
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                
                smaData.push({
                    time: data[i].time,
                    value: sum / period
                });
            }
            
            return smaData;
        }
        
        // Calculate Exponential Moving Average
        function calculateEMA(data, period) {
            const emaData = [];
            const multiplier = 2 / (period + 1);
            
            // First value is SMA
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += data[i].close;
            }
            
            let prevEMA = sum / period;
            emaData.push({
                time: data[period - 1].time,
                value: prevEMA
            });
            
            // Calculate EMA for subsequent values
            for (let i = period; i < data.length; i++) {
                const currentEMA = (data[i].close - prevEMA) * multiplier + prevEMA;
                prevEMA = currentEMA;
                
                emaData.push({
                    time: data[i].time,
                    value: currentEMA
                });
            }
            
            return emaData;
        }
        
        // Calculate Relative Strength Index (RSI)
        function calculateRSI(data, period) {
            const rsiData = [];
            const gains = [];
            const losses = [];
            
            // Calculate price changes
            for (let i = 1; i < data.length; i++) {
                const change = data[i].close - data[i-1].close;
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? Math.abs(change) : 0);
            }
            
            // Calculate initial average gain and loss
            let avgGain = gains.slice(0, period).reduce((sum, val) => sum + val, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((sum, val) => sum + val, 0) / period;
            
            // Calculate first RSI
            let rs = avgGain / (avgLoss === 0 ? 0.001 : avgLoss); // Avoid division by zero
            let rsi = 100 - (100 / (1 + rs));
            
            rsiData.push({
                time: data[period].time,
                value: rsi
            });
            
            // Calculate subsequent RSIs
            for (let i = period; i < data.length - 1; i++) {
                avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
                avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;
                
                rs = avgGain / (avgLoss === 0 ? 0.001 : avgLoss);
                rsi = 100 - (100 / (1 + rs));
                
                rsiData.push({
                    time: data[i + 1].time,
                    value: rsi
                });
            }
            
            return rsiData;
        }
        
        // Calculate MACD
        function calculateMACD(data, fastPeriod, slowPeriod, signalPeriod) {
            // Calculate EMAs
            const fastEMA = [];
            const slowEMA = [];
            const macdValues = [];
            const signalValues = [];
            const histogram = [];
            
            // Calculate fast EMA
            const fastMultiplier = 2 / (fastPeriod + 1);
            let fastSum = 0;
            for (let i = 0; i < fastPeriod; i++) {
                fastSum += data[i].close;
            }
            
            let prevFastEMA = fastSum / fastPeriod;
            fastEMA.push(prevFastEMA);
            
            for (let i = fastPeriod; i < data.length; i++) {
                const currentEMA = (data[i].close - prevFastEMA) * fastMultiplier + prevFastEMA;
                prevFastEMA = currentEMA;
                fastEMA.push(currentEMA);
            }
            
            // Calculate slow EMA
            const slowMultiplier = 2 / (slowPeriod + 1);
            let slowSum = 0;
            for (let i = 0; i < slowPeriod; i++) {
                slowSum += data[i].close;
            }
            
            let prevSlowEMA = slowSum / slowPeriod;
            slowEMA.push(prevSlowEMA);
            
            for (let i = slowPeriod; i < data.length; i++) {
                const currentEMA = (data[i].close - prevSlowEMA) * slowMultiplier + prevSlowEMA;
                prevSlowEMA = currentEMA;
                slowEMA.push(currentEMA);
            }
            
            // Calculate MACD
            const startIndex = Math.max(fastPeriod, slowPeriod) - 1;
            for (let i = 0; i <= data.length - slowPeriod; i++) {
                const macdValue = fastEMA[i + fastPeriod - 1] - slowEMA[i];
                macdValues.push({
                    time: data[i + slowPeriod - 1].time,
                    value: macdValue
                });
            }
            
            // Calculate Signal Line (EMA of MACD)
            let signalSum = 0;
            for (let i = 0; i < signalPeriod; i++) {
                signalSum += macdValues[i].value;
            }
            
            let prevSignal = signalSum / signalPeriod;
            signalValues.push({
                time: macdValues[signalPeriod - 1].time,
                value: prevSignal
            });
            
            const signalMultiplier = 2 / (signalPeriod + 1);
            
            for (let i = signalPeriod; i < macdValues.length; i++) {
                const currentSignal = (macdValues[i].value - prevSignal) * signalMultiplier + prevSignal;
                prevSignal = currentSignal;
                
                signalValues.push({
                    time: macdValues[i].time,
                    value: currentSignal
                });
                
                // Calculate histogram
                histogram.push({
                    time: macdValues[i].time,
                    value: macdValues[i].value - currentSignal,
                    color: macdValues[i].value >= currentSignal ? '#26a69a' : '#ef5350'
                });
            }
            
            return {
                macdLine: macdValues,
                signalLine: signalValues,
                histogram: histogram
            };
        }
        
        // Start everything when page is loaded
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(setupCharts, 500); // Small delay to ensure DOM is fully loaded
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (priceChart) priceChart.resize(document.getElementById('priceChart').clientWidth, document.getElementById('priceChart').clientHeight);
            if (volumeChart) volumeChart.resize(document.getElementById('volumeChart').clientWidth, document.getElementById('volumeChart').clientHeight);
            if (rsiChart) rsiChart.resize(document.getElementById('rsiChart').clientWidth, document.getElementById('rsiChart').clientHeight);
            if (macdChart) macdChart.resize(document.getElementById('macdChart').clientWidth, document.getElementById('macdChart').clientHeight);
            if (rangeChart) rangeChart.resize(document.getElementById('rangeChart').clientWidth, document.getElementById('rangeChart').clientHeight);
        });
    </script>
</body>
</html>